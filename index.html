<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Better Board Navigator</title>
    <link rel="stylesheet" href="/static/css/style.css"/>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.26.0/full/pyodide.js"></script>
    <script type="text/javascript" src="/static/js/configurePythonFunctions.js"></script>    
    <script type="text/javascript" src="/static/js/fileFunctions.js"></script>
    <script type="text/javascript" src="/static/js/events.js"></script>
    <script type="text/javascript" src="/static/js/engineAdapter.js"></script>
    <script type="text/javascript" src="/static/js/dynamicSelectableList.js"></script>
    <script type="text/javascript" src="/static/js/pinoutTable.js"></script>
    <script type="text/javascript" src="/static/js/treeview.js"></script>
    <script type="text/javascript" src="/static/js/modals.js"></script>
    <script type="text/javascript" src="/static/js/dynamicSpanList.js"></script>
    <script type="text/javascript" src="/static/js/widgetAdapter.js"></script>
</head>
<body>
    <div class="buttons-row-flexbox">
        <div class="buttons-flexbox">
            <input type="file" id="load-file-button" disabled="true">Load File</button>
        </div>
        <div class="buttons-flexbox">
            <button type="button" id="rotate-button" disabled="true">Rotate</button>
            <button type="button" id="change-side-button" disabled="true">Change Side</button>
            <button type="button" id="mirror-side-button" disabled="true">Mirror Side</button>
            <button type="button" id="toggle-outlines-button" disabled="true">Show/Hide Outlines</button>
        </div>
        <div class="buttons-flexbox">
            <button type="button" id="default-view-button" disabled="true">Default View</button>
            <button type="button" id="components-area-button" disabled="true">Area From Components</button>
        </div>
        <div class="buttons-flexbox">
            <button type="button" id="find-component-by-name-button" disabled="true">Find Component By Name</button>
            <button type="button" id="clicked-component-button" disabled="true">Toggle Clicked Component Name Mode</button>
            <button type="button" id="toggle-leave-markers-button" disabled="true">Toggle Preserve Component Markers</button>
            <button type="button" id="unselect-components-button" disabled="true">Clear Component Markers</button>
        </div>
        <div class="buttons-flexbox">
            <button type="button" id="toggle-net-marker-button" disabled="true">Toggle Net Markers</button>
            <button type="button" id="unselect-net-button" disabled="true">Unselect Net</button>
        </div>
        <div class="buttons-flexbox">
            <button type="button" id="prefix-components-button" disabled="true">Prefix Components</button>
            <button type="button" id="unselect-prefix-components-button" disabled="true">Unselect Prefix Components</button>
        </div>
        <div class="buttons-flexbox">
            <button type="button" id="help-button" disabled="true">Help</button>
        </div>
    </div>
    <div class="grid-container">
        <div id="item-left-top" class="functionality-container">
            <p>Current side: <span class="innertext" id="current-side-span"></span></p>
            <p>Highlighted prefix: <span class="innertext" id="common-prefix-span"></span></p>            
        </div>
        <div id="item-left-middle"  class="functionality-container">
            <div class="item-header">
                <p>all components</p> 
            </div>
            <div class="scrollable-list" id="scrollable-all-components-list">
            </div>
        </div>
        <div id="item-left-bottom" class="functionality-container">
            <div class="item-header"> 
                <p><span id="selected-component-span">Component</span> pinout</p>
            </div>
            <div class="table-row">
                <div>
                    <p>Pin</p>
                </div>
                <div>
                    <p>Net</p>
                </div>
            </div>
            <div id="pinout-table" class="table-body">
            </div>
        </div>
        <div id="item-center" class="functionality-container">
            <canvas id="canvas"></canvas>
        </div>
        <div id="item-right-top" class="functionality-container">
            <div class="item-header">
                <p>clicked components</p>
            </div>
            <div id="clicked-components">
                <p></p>
            </div>
        </div>
        <div id="item-right-middle" class="functionality-container">
            <div class="item-header">
                <p>marked components</p>
            </div>
            <div class="scrollable-list" id="scrollable-marked-components-list">
            </div>
        </div>
        <div id="item-right-bottom" class="functionality-container">
            <div class="item-header"> 
                <p>nets list</p>
            </div>
            <div id="net-treeview" class="tree-view">
            </div>
        </div>
    </div>
    <div id="text-modal" class="modal">
        <div class="modal-content">
            <span class="close" id="text-modal-close-span">&times;</span>
            <h2 id="text-modal-header"></h2>
            <input type="text" id="text-modal-input" placeholder="">
            <button id="text-modal-submit-text">Ok</button>
        </div>
    </div>
    <div id="paragraph-modal" class="modal">
        <div class="paragraph-modal-content">
            <span class="close" id="paragraph-modal-close-span">&times;</span>
            <h2 id="paragraph-modal-header"></h2>
            <p id="paragraph-modal-p"></p>
        </div>
    </div>
    <script>
        let pyodide = null;
        let loadedFileName = "";
        let isMousePressed = false;
        let isMouseClickedFirstTime = false;
        let isSideBottom = true;
        let resizeTimeout = null;
        let isRotateActive = false;
        let isFindComponentByClickActive = false;
        let isSelectionModeSingle = true;
        let modalBoxComponentName = "";
        let isTextModalInputFocused = false;

        const sideMap = {true: "B", false: "T"};
        const selectionModesMap = {true: "single", false: "multiple"};

        const canvas = document.getElementById("canvas");
        const canvasParent = document.getElementById("item-center");
        const loadFileButton = document.getElementById("load-file-button");
        const changeSideButton = document.getElementById("change-side-button");
        const rotateButton = document.getElementById("rotate-button");
        const mirrorSideButton = document.getElementById("mirror-side-button");
        const toggleOutlinesButton = document.getElementById("toggle-outlines-button");
        const resetViewButton = document.getElementById("default-view-button");    
        const areaFromComponentsButton = document.getElementById("components-area-button");
        const toggleFindComponentByClickButton = document.getElementById("clicked-component-button");
        const clickedComponentContainer = document.getElementById("clicked-components");
        const allComponentsContainer = document.getElementById("scrollable-all-components-list");
        const preserveComponentMarkesButton = document.getElementById("toggle-leave-markers-button");
        const clearMarkersButton = document.getElementById("unselect-components-button");
        const markedComponentsContainer = document.getElementById("scrollable-marked-components-list");
        const pinoutTableContainer = document.getElementById("pinout-table");
        const netTreeviewContainer = document.getElementById("net-treeview");
        const toggleNetMarkersButton = document.getElementById("toggle-net-marker-button");
        const unselectNetButton = document.getElementById("unselect-net-button");
        const currentSideSpan = document.getElementById("current-side-span");
        const findComponentUsingNameButton = document.getElementById("find-component-by-name-button");
        const prefixComponentsButton = document.getElementById("prefix-components-button");
        const unselectPrefixComponentsButton = document.getElementById("unselect-prefix-components-button");
        const commonPrefixSpan = document.getElementById("common-prefix-span");
        const selectedComponentSpan = document.getElementById("selected-component-span");


        var textModalContainer = document.getElementById("text-modal");
        var textModalCloseSpan = document.getElementById("text-modal-close-span");
        var textModalPromptHeader = document.getElementById("text-modal-header");
        var textModalInput = document.getElementById("text-modal-input");
        var textModalSubmitButton = document.getElementById("text-modal-submit-text");

        var paragraphModalContainer = document.getElementById("paragraph-modal");
        var paragraphModalCloseSpan = document.getElementById("paragraph-modal-close-span");
        var paragraphModalPromptHeader = document.getElementById("paragraph-modal-header");
        var paragraphModalTextParagraph = document.getElementById("paragraph-modal-p");

        var modalSubmit = new ModalSubmit(textModalContainer, textModalCloseSpan, 
                                            textModalPromptHeader, textModalInput, 
                                            textModalSubmitButton);
        var modalParagraph = new ModalParagraph(paragraphModalContainer, paragraphModalCloseSpan, 
                                                paragraphModalPromptHeader, paragraphModalTextParagraph);
        var allComponentsList = DynamicSelectableListAdapter.initDynamicSelectableList(allComponentsContainer);
        var markedComponentsList = DynamicSelectableListAdapter.initDynamicSelectableList(markedComponentsContainer);
        var pinoutTable = PinoutTableAdapter.initPinoutTable(pinoutTableContainer);
        var netsTreeview = new NetTreeView(netTreeviewContainer);
        var clickedComponentSpanList = SpanListAdapter.initSpanList(clickedComponentContainer);

        function currentSide(){
            return sideMap[isSideBottom];
        }

        function changeSide(){            
            isSideBottom = !isSideBottom;
            currentSideSpan.innerText = currentSide();
        }

        function setCanvasDimensions(){
            canvas.width = canvasParent.clientWidth;
            canvas.height = canvasParent.clientHeight;
        }

        // This is a workaround about the fact that the pygame-ce is not run in an inifite loop but as an image generator. 
        // As result "main game loop" doesn't exist, which results in throwing errors when any key is pressed down
        // This cludge overrides JS error handler and ignores these event errors and manually sets keyboard behaviour (onkeydown event)
        window.onerror = function(message, source, lineno, colno, error) {
            if (error.message.includes("emscripten_compute_dom_pk_code")){
                return true;
            }
        }
        
        // ignore syntax errors from python's regex
        console.warn = () => {};

        textModalInput.addEventListener("focus", () => {
            isTextModalInputFocused = true;
        });

        textModalInput.addEventListener("blur", () => {
            isTextModalInputFocused = false;
        });


        document.addEventListener("DOMContentLoaded", async () => {
            pinoutTable.generateTable();
            
            pyodide = await loadPyodide();
            await configurePythonPath(pyodide);                      
            await loadPygame(pyodide);            
            await loadLocalModules(pyodide);

            pyodide.canvas.setCanvas2D(canvas);
            loadFileButton.disabled = false;
            setCanvasDimensions();
            
            window.addEventListener("resize", windowResizeEvent);
            window.addEventListener("keydown", keyDownEvent);

            canvas.addEventListener("mousedown", mouseDownEvent);
            canvas.addEventListener("mouseup", mouseUpEvent);       
            canvas.addEventListener("mousemove", mouseMoveEvent);
            canvas.addEventListener("wheel", EngineAdapter.zoomInOut);

            loadFileButton.addEventListener("change", loadFileEvent);
            changeSideButton.addEventListener("click", EngineAdapter.changeSide);
            rotateButton.addEventListener("click", rotateEvent);
            mirrorSideButton.addEventListener("click", EngineAdapter.mirrorSide);
            toggleOutlinesButton.addEventListener("click", EngineAdapter.toggleOutlines);
            resetViewButton.addEventListener("click", EngineAdapter.resetView);
            areaFromComponentsButton.addEventListener("click", EngineAdapter.areaFromComponents);
            toggleFindComponentByClickButton.addEventListener("click", toggleFindComponentByClickEvent);
            preserveComponentMarkesButton.addEventListener("click", preserveComponentMarkesEvent);
            clearMarkersButton.addEventListener("click", EngineAdapter.clearMarkers);
            toggleNetMarkersButton.addEventListener("click", toggleNetMarkersEvent);
            unselectNetButton.addEventListener("click", unselectNetEvent);            
            findComponentUsingNameButton.addEventListener("click", findComponentUsingNameEvent);
            prefixComponentsButton.addEventListener("click", showCommonPrefixComponentsEvent);
            unselectPrefixComponentsButton.addEventListener("click", hideCommonPrefixComponentsEvent);
        });
    </script>
</body>
</html>