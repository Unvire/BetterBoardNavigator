<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Better Board Navigator</title>
    <link rel="stylesheet" href="/static/css/style.css"/>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.26.0/full/pyodide.js"></script>
    <script type="text/javascript" src="/static/js/configurePythonFunctions.js"></script>    
    <script type="text/javascript" src="/static/js/fileFunctions.js"></script>   
    <script type="text/javascript" src="/static/js/events.js"></script>
    <script type="text/javascript" src="/static/js/dynamicSelectableList.js"></script>
    <script type="text/javascript" src="/static/js/pinoutTable.js"></script>
    <script type="text/javascript" src="/static/js/treeview.js"></script>
</head>
<body>
    <div class="buttons-row-flexbox">
        <div class="buttons-flexbox">
            <input type="file" id="load-file-button" disabled="true">Load File</button>
            <button type="button" id="change-colors-button">Change Colors</button>
        </div>
        <div class="buttons-flexbox">
            <button type="button" id="rotate-button" disabled="true">Rotate</button>
            <button type="button" id="change-side-button" disabled="true">Change Side</button>
            <button type="button" id="mirror-side-button" disabled="true">Mirror Side</button>
            <button type="button" id="toggle-outlines-button" disabled="true">Show/Hide Outlines</button>
        </div>
        <div class="buttons-flexbox">
            <button type="button" id="default-view-button" disabled="true">Default View</button>
            <button type="button" id="components-area-button" disabled="true">Area From Components</button>
        </div>
        <div class="buttons-flexbox">
            <button type="button" id="clicked-component-button" disabled="true">Toggle Clicked Component Name Mode</button>
            <button type="button" id="toggle-leave-markers-button" disabled="true">Toggle preserve component markers</button>
            <button type="button" id="unselect-components-button" disabled="true">Clear component markers</button>
        </div>
        <div class="buttons-flexbox">
            <button type="button" id="toggle-net-marker-button" disabled="true">Hide net markers</button>
            <button type="button" id="unselect-net-button" disabled="true">Unselect net</button>
        </div>
        <div class="buttons-flexbox">
            <button type="button" id="prefix-components-button" disabled="true">Prefix components</button>
            <button type="button" id="unselect-prefix-button" disabled="true">Unselect prefix components</button>
        </div>
        <div class="buttons-flexbox">
            <button type="button" id="help-button" disabled="true">Help</button>
            <button type="button" id="about-button" disabled="true">About</button>
        </div>
    </div>
    <div class="grid-container">
        <div class="item-left-top">
            <p>current side</p>
        </div>
        <div class="item-left-middle">
            <p>all components</p> 
            <div class="scrollable-list" id="scrollable-all-components-list">
            </div>
        </div>
        <div class="item-left-bottom" id="pinout-table">
            <p>component pinout</p>
        </div>
        <div class="item-center" id="item-center">
            <canvas id="canvas"></canvas>
        </div>
        <div class="item-right-top">
            <p>nets list</p>
            <div id="net-treeview" class="tree-view">
            </div>
        </div>
        <div class="item-right-middle">
            <p>marked components</p>
            <div class="scrollable-list" id="scrollable-marked-components-list">
            </div>
        </div>
        <div class="item-right-bottom">
            <p>clicked components</p>
            <p id="clicked-components"></p>
        </div>
    </div>
    <script>
        let pyodide = null;
        let loadedFileName = "";
        let isMousePressed = false;
        let isMouseClickedFirstTime = false;
        let isSideBottom = true;
        let resizeTimeout = null;
        let isRotateActive = false;
        let isFindComponentByClickActive = false;
        let isSelectionModeSingle = true;

        const sideMap = {true: 'B', false: 'T'};
        const selectionModesMap = {true: 'single', false: 'multiple'};

        const canvas = document.getElementById('canvas');
        const canvasParent = document.getElementById('item-center');
        const loadFileButton = document.getElementById('load-file-button');
        const changeSideButton = document.getElementById('change-side-button');
        const rotateButton = document.getElementById('rotate-button');
        const mirrorSideButton = document.getElementById('mirror-side-button');
        const toggleOutlinesButton = document.getElementById('toggle-outlines-button');
        const resetViewButton = document.getElementById('default-view-button');    
        const areaFromComponentsButton = document.getElementById('components-area-button');
        const toggleFindComponentByClickButton = document.getElementById('clicked-component-button');
        const clickedComponentContainer = document.getElementById("clicked-components");
        const allComponentsContainer = document.getElementById('scrollable-all-components-list');
        const preserveComponentMarkesButton = document.getElementById('toggle-leave-markers-button');
        const clearMarkersButton = document.getElementById('unselect-components-button');
        const markedComponentsContainer = document.getElementById('scrollable-marked-components-list');
        const pinoutTableContainer = document.getElementById('pinout-table');
        const netTreeviewContainer = document.getElementById('net-treeview')

        var allComponentsList = new DynamicSelectableList(allComponentsContainer);
        var markedComponentsList = new DynamicSelectableList(markedComponentsContainer);
        var pinoutTable = new PinoutTable(pinoutTableContainer);
        var netsTreeview = new NetTreeView(netTreeviewContainer);

        function currentSide(){
            return sideMap[isSideBottom];
        }

        function changeSide(){            
            isSideBottom = !isSideBottom;
        }

        function setCanvasDimensions(){
            canvas.width = canvasParent.clientWidth;
            canvas.height = canvasParent.clientHeight;
        }

        // This is a workaround about the fact that the pygame-ce is not run in an inifite loop but as an image generator. 
        // As result "main game loop" doesn't exist, which results in throwing errors when any key is pressed down
        // In other words event is not handled, because game loop does not exist
        // This cludge overrides JS error handler and ignores these event errors...
        window.onerror = function(message, source, lineno, colno, error) {
            if (error.message.includes("emscripten_compute_dom_pk_code")){
                console.log(message);
                return true;
            }
        }

        document.addEventListener("DOMContentLoaded", async () => {
            pinoutTable.generateTable();
            
            pyodide = await loadPyodide();
            await configurePythonPath(pyodide);                      
            await loadPygame(pyodide);            
            await loadLocalModules(pyodide);

            pyodide.canvas.setCanvas2D(canvas);
            loadFileButton.disabled = false;
            setCanvasDimensions();
            
            window.addEventListener("resize", windowResizeEvent);
            window.addEventListener("keydown", keyDownEvent);

            canvas.addEventListener("mousedown", mouseDownEvent);
            canvas.addEventListener("mouseup", mouseUpEvent);       
            canvas.addEventListener("mousemove", mouseMoveEvent);
            canvas.addEventListener("wheel", mouseScrollEvent);

            loadFileButton.addEventListener("change", loadFileEvent);
            changeSideButton.addEventListener("click", changeSideEvent);
            rotateButton.addEventListener("click", rotateEvent);
            mirrorSideButton.addEventListener("click", mirrorSideEvent);
            toggleOutlinesButton.addEventListener("click", toggleOutlinesEvent);
            resetViewButton.addEventListener("click", resetViewEvent);
            areaFromComponentsButton.addEventListener("click", areaFromComponentsEvent);
            toggleFindComponentByClickButton.addEventListener("click", toggleFindComponentByClickEvent);
            preserveComponentMarkesButton.addEventListener("click", preserveComponentMarkesEvent);
            clearMarkersButton.addEventListener("click", clearMarkersEvent);
        });
    </script>
</body>
</html>