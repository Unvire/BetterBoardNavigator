<!DOCTYPE html>
<html>
<head>
  <title>Pyodide Pygame-CE Example</title>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.26.0/full/pyodide.js"></script>
</head>
<body>
  <h1>Pyodide Pygame-CE Example</h1>
  <canvas id="pygame-canvas" width="640" height="480"></canvas>
  <script type="text/javascript">
    async function main() {
      let pyodide = await loadPyodide();
      await pyodide.loadPackage(['micropip']);
      await pyodide.runPythonAsync(`
        import micropip
        await micropip.install('pygame-ce')
        await micropip.install('numpy')
      `);

      async function runPygame() {
        try {
          await pyodide.runPythonAsync(`
            import pygame
            import numpy as np

            pygame.init()
            screen = pygame.Surface((640, 480))

            # Fill the surface with white color
            screen.fill((255, 255, 255))

            # Draw a red circle
            pygame.draw.circle(screen, (255, 0, 0), (320, 240), 50)

            # Get the pixel data from the surface
            pixel_array = pygame.surfarray.array3d(screen)
            pixel_array = np.transpose(pixel_array, (1, 0, 2))  # Transpose to match canvas dimensions
          `);

          let pixelArray = pyodide.globals.get('pixel_array').toJs();
          let canvas = document.getElementById('pygame-canvas');
          let ctx = canvas.getContext('2d');
          let imageData = ctx.createImageData(canvas.width, canvas.height);

          // Transfer pixel data to canvas
          for (let y = 0; y < canvas.height; y++) {
            for (let x = 0; x < canvas.width; x++) {
              let index = (y * canvas.width + x) * 4;
              imageData.data[index] = pixelArray[y][x][0];     // Red
              imageData.data[index + 1] = pixelArray[y][x][1]; // Green
              imageData.data[index + 2] = pixelArray[y][x][2]; // Blue
              imageData.data[index + 3] = 255;                 // Alpha
            }
          }

          ctx.putImageData(imageData, 0, 0);

        } catch (e) {
          console.error("Error running Pygame script:", e);
        }
      }

      await runPygame();
    }

    main();
  </script>
</body>
</html>